name: Seed MongoDB

on:
  workflow_dispatch:

jobs:
  build-and-seed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Show commit
        run: git log -1 --oneline

      - name: Build Docker image
        uses: docker/build-push-action@v3
        with:
          context: .
          push: false
          tags: base-dr-seeder:latest
          no-cache: true
          build-args: |
            GIT_COMMIT=${{ github.sha }}

      - name: Inspect built image
        run: |
          echo "--- Inspecting built image for debug strings ---"
          # Print presence of our diagnostic log and head of worker file and seed_all inside the image
          docker run --rm base-dr-seeder:latest sh -c \
            "grep -n 'Par√°metros recibidos' /app/src/*.js || true; echo '--- worker file head ---'; sed -n '1,200p' /app/src/worker_seed_clientes.js || true; echo '--- seed_all head ---'; sed -n '1,200p' /app/src/seed_all.js || true"

      - name: Run seeder
        run: |
          docker run --rm \
            -e MONGO_URI="${{ secrets.MONGO_URI }}" \
            -e SEED_N="${{ secrets.SEED_N }}" \
            -e SEED_N_CLIENTES="${{ secrets.SEED_N_CLIENTES }}" \
            -e SEED_N_PRODUCTOS="${{ secrets.SEED_N_PRODUCTOS }}" \
            -e SEED_N_FACTURAS="${{ secrets.SEED_N_FACTURAS }}" \
            -e SEED_BATCH="${{ secrets.SEED_BATCH }}" \
            -e SEED_WORKERS="${{ secrets.SEED_WORKERS }}" \
            base-dr-seeder:latest